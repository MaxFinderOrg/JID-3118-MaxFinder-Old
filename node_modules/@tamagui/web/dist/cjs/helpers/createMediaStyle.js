"use strict";
var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);
var createMediaStyle_exports = {};
__export(createMediaStyle_exports, {
  MEDIA_SEP: () => MEDIA_SEP,
  createMediaStyle: () => createMediaStyle
});
module.exports = __toCommonJS(createMediaStyle_exports);
var import_config = require("../config");
var import_useMedia = require("../hooks/useMedia");
var import_getGroupPropParts = require("./getGroupPropParts");
const MEDIA_SEP = "_";
let prefixes = null;
let selectors = null;
const groupPseudoToPseudoCSSMap = {
  press: "active"
};
const createMediaStyle = (styleObject, mediaKeyIn, mediaQueries, negate, priority) => {
  const { property, identifier, rules } = styleObject;
  const conf = (0, import_config.getConfig)();
  const enableMediaPropOrder = conf.settings.mediaPropOrder;
  const isThemeMedia = mediaKeyIn.startsWith("theme-");
  const isPlatformMedia = !isThemeMedia && mediaKeyIn.startsWith("platform-");
  const isGroup = !isThemeMedia && !isPlatformMedia && mediaKeyIn.startsWith("group-");
  const isNonWindowMedia = isThemeMedia || isPlatformMedia || isGroup;
  const negKey = negate ? "0" : "";
  const ogPrefix = identifier.slice(0, identifier.indexOf("-") + 1);
  const id = `${ogPrefix}${MEDIA_SEP}${mediaKeyIn.replace("-", "")}${negKey}${MEDIA_SEP}`;
  let styleRule = "";
  let groupMediaKey;
  let containerName;
  let nextIdentifier = identifier.replace(ogPrefix, id);
  let styleInner = rules.map((rule) => rule.replace(identifier, nextIdentifier)).join(";");
  if (isNonWindowMedia) {
    const precedenceImportancePrefix = new Array((priority || 0) + (isGroup ? 1 : 0)).fill(":root").join("");
    if (isThemeMedia || isGroup) {
      const groupInfo = (0, import_getGroupPropParts.getGroupPropParts)(mediaKeyIn);
      const mediaName = groupInfo == null ? void 0 : groupInfo.name;
      groupMediaKey = groupInfo == null ? void 0 : groupInfo.media;
      if (isGroup) {
        containerName = mediaName;
      }
      const name = (isGroup ? "group_" : "") + mediaName;
      const selectorStart = styleInner.indexOf(":root");
      const selectorEnd = styleInner.lastIndexOf("{");
      const selector = styleInner.slice(selectorStart, selectorEnd);
      const precedenceSpace = conf.themeClassNameOnRoot ? "" : " ";
      const pseudoSelectorName = groupInfo.pseudo ? groupPseudoToPseudoCSSMap[groupInfo.pseudo] || groupInfo.pseudo : void 0;
      const pseudoSelector = pseudoSelectorName ? `:${pseudoSelectorName}` : "";
      const presedencePrefix = `:root${precedenceImportancePrefix}${precedenceSpace}`;
      const mediaSelector = `.t_${name}${pseudoSelector}`;
      const nextSelector = `${presedencePrefix}${mediaSelector} ${selector.replace(
        ":root",
        ""
      )}`;
      styleRule = styleInner.replace(selector, nextSelector);
    } else {
      styleRule = `${precedenceImportancePrefix}${styleInner}`;
    }
  }
  if (!isNonWindowMedia || groupMediaKey) {
    if (!selectors) {
      const mediaKeys = Object.keys(mediaQueries);
      selectors = Object.fromEntries(
        mediaKeys.map((key) => [key, (0, import_useMedia.mediaObjectToString)(mediaQueries[key])])
      );
      if (!enableMediaPropOrder) {
        prefixes = Object.fromEntries(
          mediaKeys.map((k, index) => [k, new Array(index + 1).fill(":root").join("")])
        );
      }
    }
    const mediaKey = groupMediaKey || mediaKeyIn;
    const mediaSelector = selectors[mediaKey];
    const screenStr = negate ? "not all and" : "";
    const mediaQuery = `${screenStr} ${mediaSelector}`;
    const precedenceImportancePrefix = groupMediaKey ? "" : enableMediaPropOrder ? (
      // this new array should be cached
      new Array(priority).fill(":root").join("")
    ) : (
      // @ts-ignore
      prefixes[mediaKey]
    );
    const prefix = groupMediaKey ? `@container ${containerName}` : "@media";
    if (groupMediaKey) {
      styleInner = styleRule;
    }
    if (styleInner.includes(prefix)) {
      styleRule = styleInner.replace("{", ` and ${mediaQuery} {`);
    } else {
      styleRule = `${prefix} ${mediaQuery}{${precedenceImportancePrefix}${styleInner}}`;
    }
  }
  return {
    property,
    rules: [styleRule],
    identifier: nextIdentifier
  };
};
// Annotate the CommonJS export names for ESM import in node:
0 && (module.exports = {
  MEDIA_SEP,
  createMediaStyle
});
//# sourceMappingURL=createMediaStyle.js.map
